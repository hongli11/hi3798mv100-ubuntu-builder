name: Hi3798MV100 Ubuntu 自动编译

# 触发条件：推送代码/手动触发
on:
  push:
    branches: [ main ]
    paths:
      - 'build_rootfs.sh'
      - '.github/workflows/auto-build.yml'
  workflow_dispatch:  # 手动触发开关

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40  # 延长超时（下载镜像需要时间）
    env:
      # 全局环境变量（可按需修改）
      ROOT_PASSWORD: ${{ secrets.ROOT_PASSWORD }}  # 从GitHub Secrets读取密码
      NETWORK_MODE: "DHCP"
      HOSTNAME: "hi3798mv100"

    steps:
      # 1. 拉取仓库代码
      - name: 拉取仓库源码
        uses: actions/checkout@v4

      # 2. 缓存Ubuntu基础镜像（避免重复下载）
      - name: 缓存Ubuntu Base镜像
        uses: actions/cache@v3
        with:
          path: ./ubuntu-base.tar.gz
          key: ${{ runner.os }}-ubuntu-base-20.04-armhf
          restore-keys: |
            ${{ runner.os }}-ubuntu-base-

      # 3. 执行构建脚本
      - name: 执行自动化构建
        run: |
          chmod +x ./build_rootfs.sh
          ./build_rootfs.sh

      # 4. 上传构建产物
      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: hi3798mv100-ubuntu-build-${{ github.sha }}
          path: |
            ./hi3798mv100-ubuntu-*.img
            ./hi3798mv100-ubuntu-backup-*.gz
          retention-days: 90  # 产物保留90天
          if-no-files-found: error

      # 5. （可选）上传产物到GitHub Release
      - name: 上传到GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'  # 仅main分支推送Release
        with:
          tag_name: build-${{ github.run_id }}
          name: 自动构建-${{ github.run_id }}
          files: |
            ./hi3798mv100-ubuntu-*.img
            ./hi3798mv100-ubuntu-backup-*.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动生成的Token
