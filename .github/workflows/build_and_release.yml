name: Build and Release Hi3798MV100 Ubuntu RootFS

on:
  workflow_dispatch: # 允许在GitHub网页上手动点击运行
  push:
    tags:
      - 'v*' # 当推送v开头的标签时自动运行（如 git tag v1.0 && git push --tags）

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static rsync gzip parted kpartx \
                               dosfstools binfmt-support

    - name: 准备基础系统
      run: |
        # 1. 创建并格式化镜像（大小可根据需要调整，此处为1600MB）
        IMG_NAME="hi3798mv100-ubuntu-rootfs.img"
        dd if=/dev/zero of=$IMG_NAME bs=1M count=0 seek=1600
        mkfs.ext4 -F $IMG_NAME

        # 2. 挂载镜像
        sudo mkdir -p /mnt/rootfs
        sudo mount -o loop $IMG_NAME /mnt/rootfs

        # 3. 解压Ubuntu基础包到镜像
        echo "解压Ubuntu基础系统..."
        sudo tar -xpf ubuntu-base-*.tar.gz -C /mnt/rootfs

    - name: 配置系统并安装软件 (Chroot环境)
      run: |
        # 准备chroot环境
        sudo cp /usr/bin/qemu-arm-static /mnt/rootfs/usr/bin/
        sudo cp -L /etc/resolv.conf /mnt/rootfs/etc/

        # 挂载虚拟文件系统
        sudo mount -t proc /proc /mnt/rootfs/proc
        sudo mount -t sysfs /sys /mnt/rootfs/sys
        sudo mount -o bind /dev /mnt/rootfs/dev
        sudo mount -o bind /dev/pts /mnt/rootfs/dev/pts

        # 在chroot环境中执行安装和配置命令
        sudo chroot /mnt/rootfs /bin/bash << 'CHROOT_EOF'
        # 设置环境变量和非交互式前端
        export DEBIAN_FRONTEND=noninteractive
        export LC_ALL=C

        # 更新源并安装基础包
        apt-get update
        apt-get upgrade -y
        apt-get install -y systemd-sysv rsyslog sudo vim bash-completion \
          ssh net-tools ethtool ifupdown network-manager \
          iputils-ping wget curl htop less lsof

        # 网络配置示例（使用DHCP，您之后可按需修改）
        cat > /etc/network/interfaces.d/eth0 << 'NET_EOF'
        auto eth0
        iface eth0 inet dhcp
        NET_EOF

        # 设置主机名
        echo "hi3798mv100" > /etc/hostname

        # 设置root密码（请刷机后立即修改！）
        echo "root:root123" | chpasswd
        echo "PermitRootLogin yes" >> /etc/ssh/sshd_config

        # 清理APT缓存以减小镜像体积
        apt-get clean
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

        # 退出chroot
        exit
        CHROOT_EOF

        # 卸载虚拟文件系统
        sudo umount -lf /mnt/rootfs/dev/pts
        sudo umount -lf /mnt/rootfs/dev
        sudo umount -lf /mnt/rootfs/sys
        sudo umount -lf /mnt/rootfs/proc

    - name: 完成镜像制作并压缩
      run: |
        # 卸载镜像
        sudo umount /mnt/rootfs

        # 为镜像文件生成压缩包（用于刷机备份）
        gzip -9 -k -c hi3798mv100-ubuntu-rootfs.img > hi3798mv100-backup-$(date +%Y%m%d).gz

        # 列出生成的文件
        ls -lh *.img *.gz

    - name: 发布到 GitHub Release
      uses: softprops/action-gh-release@v1
      if: success() && startsWith(github.ref, 'refs/tags/v')
      with:
        files: |
          hi3798mv100-ubuntu-rootfs.img
          hi3798mv100-backup-*.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
