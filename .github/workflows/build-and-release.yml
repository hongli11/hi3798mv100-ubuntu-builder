name: Build and Release Pure RootFS

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-and-release.yml'  # åªæœ‰æ­¤æ–‡ä»¶æ›´æ”¹æ—¶æ‰è§¦å‘

jobs:
  build-pure-rootfs:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½å®˜æ–¹ Ubuntu Base
      run: |
        echo "ä¸‹è½½å®˜æ–¹ Ubuntu Base 20.04.5..."
        wget -c https://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.5-base-armhf.tar.gz
        echo "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°:"
        ls -lh *.tar.gz

    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-user-static \
          rsync \
          gzip \
          e2fsprogs \
          parted \
          dosfstools \
          fdisk

    - name: å‡†å¤‡æ ¹æ–‡ä»¶ç³»ç»Ÿ
      run: |
        set -e
        
        # åˆ›å»ºå¹¶æ¸…ç†ç›®å½•
        ROOTFS_DIR=$(pwd)/ubuntu_rootfs
        sudo rm -rf $ROOTFS_DIR
        mkdir -p $ROOTFS_DIR
        
        echo "è§£å‹ Ubuntu Base..."
        sudo tar -xpf ubuntu-base-20.04.5-base-armhf.tar.gz -C $ROOTFS_DIR
        
        echo "å‡†å¤‡ chroot ç¯å¢ƒ..."
        sudo cp /usr/bin/qemu-arm-static $ROOTFS_DIR/usr/bin/
        sudo cp /etc/resolv.conf $ROOTFS_DIR/etc/
        
        # æŒ‚è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
        sudo mount -t proc /proc $ROOTFS_DIR/proc
        sudo mount -t sysfs /sys $ROOTFS_DIR/sys
        sudo mount -o bind /dev $ROOTFS_DIR/dev
        sudo mount -o bind /dev/pts $ROOTFS_DIR/dev/pts

    - name: åœ¨ chroot ä¸­é…ç½®ç³»ç»Ÿ
      run: |
        set -e
        ROOTFS_DIR=$(pwd)/ubuntu_rootfs
        
        # å®Œæ•´çš„ chroot é…ç½®è„šæœ¬
        sudo chroot $ROOTFS_DIR /bin/bash << 'CHROOT_EOF'
        #!/bin/bash
        set -e -x
        
        export DEBIAN_FRONTEND=noninteractive
        export LC_ALL=C
        
        echo "=== å¼€å§‹é…ç½®çº¯å‡€ Ubuntu ç³»ç»Ÿ ==="
        
        # å…³é”®ï¼šæŒ‚è½½ tmpfs è§£å†³ç©ºé—´é—®é¢˜
        echo "æŒ‚è½½ tmpfs è§£å†³ç©ºé—´é™åˆ¶..."
        mount -t tmpfs tmpfs /tmp
        mount -t tmpfs tmpfs /var/cache/apt/archives
        
        # é…ç½®è½¯ä»¶æºï¼ˆä½¿ç”¨åä¸ºäº‘ï¼Œæ›´ç¨³å®šï¼‰
        echo "é…ç½®åä¸ºäº‘è½¯ä»¶æº..."
        cat > /etc/apt/sources.list << 'SOURCES_EOF'
deb http://repo.huaweicloud.com/ubuntu-ports/ focal main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-updates main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-security main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-backports main restricted universe multiverse
SOURCES_EOF
        
        # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
        echo "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
        apt-get update
        
        # å®‰è£…åŸºç¡€ç³»ç»Ÿç»„ä»¶
        echo "å®‰è£… systemd å’ŒåŸºç¡€åŒ…..."
        apt-get install -y systemd systemd-sysv dbus
        
        # å®‰è£…ç½‘ç»œç»„ä»¶
        echo "å®‰è£…ç½‘ç»œç»„ä»¶..."
        apt-get install -y \
          ifupdown \
          net-tools \
          iproute2 \
          iputils-ping \
          openssh-server \
          ssh \
          network-manager
        
        # å®‰è£…å¸¸ç”¨å·¥å…·
        echo "å®‰è£…å¸¸ç”¨å·¥å…·..."
        apt-get install -y \
          sudo \
          vim-tiny \
          less \
          lsof \
          htop \
          wget \
          curl \
          rsync \
          cron \
          rsyslog \
          logrotate \
          bash-completion \
          ca-certificates
        
        # ç³»ç»Ÿé…ç½®
        echo "é…ç½®ç³»ç»Ÿè®¾ç½®..."
        
        # ä¸»æœºå
        echo "hi3798mv100" > /etc/hostname
        
        # hosts æ–‡ä»¶
        cat > /etc/hosts << 'HOSTS_EOF'
127.0.0.1   localhost
127.0.1.1   hi3798mv100
::1         ip6-localhost ip6-loopback
fe00::0     ip6-localnet
ff00::0     ip6-mcastprefix
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters
HOSTS_EOF
        
        # æ—¶åŒº
        ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        
        # root å¯†ç 
        echo "root:root123" | chpasswd
        
        # SSH é…ç½®
        echo "é…ç½® SSH..."
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        
        # ç½‘ç»œé…ç½®ï¼ˆDHCPï¼‰
        mkdir -p /etc/network/interfaces.d
        cat > /etc/network/interfaces.d/eth0 << 'NET_EOF'
auto eth0
iface eth0 inet dhcp
NET_EOF
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p /var/run/sshd
        mkdir -p /root/.ssh
        
        # æ¸…ç† APT ç¼“å­˜
        echo "æ¸…ç†ç³»ç»Ÿ..."
        apt-get autoremove -y
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        rm -rf /tmp/*
        rm -rf /var/tmp/*
        
        # ç§»é™¤ qemu æ¨¡æ‹Ÿå™¨
        rm -f /usr/bin/qemu-arm-static
        
        echo "=== ç³»ç»Ÿé…ç½®å®Œæˆ ==="
        echo "çº¯å‡€ Ubuntu ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª"
        CHROOT_EOF

    - name: æ¸…ç† chroot ç¯å¢ƒ
      run: |
        ROOTFS_DIR=$(pwd)/ubuntu_rootfs
        
        # å¸è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
        sudo umount -lf $ROOTFS_DIR/dev/pts 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/dev 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/sys 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/proc 2>/dev/null || true
        
        echo "chroot ç¯å¢ƒå·²æ¸…ç†"

    - name: åˆ›å»ºæ ‡å‡†å¤§å°çš„é•œåƒ
      run: |
        set -e
        
        ROOTFS_DIR=$(pwd)/ubuntu_rootfs
        
        # ç¡®å®šé•œåƒå¤§å°ï¼ˆä¸åŸå§‹é•œåƒä¸€è‡´ï¼‰
        IMG_SIZE=837660672  # åŸå§‹é•œåƒçš„å­—èŠ‚æ•°ï¼Œçº¦ 799MB
        
        echo "åˆ›å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿé•œåƒ..."
        
        # åˆ›å»ºç©ºç™½é•œåƒæ–‡ä»¶
        IMG_NAME="rootfs-32.img"
        dd if=/dev/zero of="$IMG_NAME" bs=1 count=0 seek=$IMG_SIZE
        
        # åˆ›å»º ext4 æ–‡ä»¶ç³»ç»Ÿ
        mkfs.ext4 -F -L "rootfs" "$IMG_NAME"
        
        # æŒ‚è½½å¹¶å¤åˆ¶æ–‡ä»¶
        TEMP_MOUNT=$(pwd)/temp_mount
        mkdir -p "$TEMP_MOUNT"
        
        echo "æŒ‚è½½é•œåƒå¹¶å¤åˆ¶ç³»ç»Ÿæ–‡ä»¶..."
        sudo mount -o loop "$IMG_NAME" "$TEMP_MOUNT"
        sudo cp -a $ROOTFS_DIR/* "$TEMP_MOUNT"/
        sync
        sudo umount "$TEMP_MOUNT"
        
        # æ£€æŸ¥å¹¶ä¿®å¤æ–‡ä»¶ç³»ç»Ÿ
        e2fsck -p -f "$IMG_NAME" || true
        
        # è·å–é•œåƒä¿¡æ¯
        echo "é•œåƒåˆ›å»ºå®Œæˆ:"
        ls -lh "$IMG_NAME"
        echo "æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯:"
        dumpe2fs -h "$IMG_NAME" | grep -i "block count\|inode count"

    - name: åˆ›å»ºå‹ç¼©ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
      run: |
        # åˆ›å»ºå‹ç¼©ç‰ˆæœ¬ï¼ŒèŠ‚çœä¸‹è½½æµé‡
        gzip -9 -c "rootfs-32.img" > "rootfs-32.img.gz"
        
        echo "å‹ç¼©ç‰ˆæœ¬åˆ›å»ºå®Œæˆ:"
        ls -lh rootfs-32.img*
        
        # è®¡ç®—å‹ç¼©ç‡
        ORIG_SIZE=$(stat -c%s "rootfs-32.img")
        GZ_SIZE=$(stat -c%s "rootfs-32.img.gz")
        RATIO=$(echo "scale=1; 100*$GZ_SIZE/$ORIG_SIZE" | bc)
        echo "å‹ç¼©ç‡: ${RATIO}%"

    - name: å‡†å¤‡ Release æ–‡ä»¶
      run: |
        # åˆ›å»ºåŒ…å«è¯¦ç»†ä¿¡æ¯çš„ README
        cat > RELEASE_NOTES.md << 'EOF'
        # çº¯å‡€ Ubuntu RootFS for Hi3798mv100
        
        ## é•œåƒä¿¡æ¯
        - **ç³»ç»Ÿ**: Ubuntu 20.04.5 Base (armhf)
        - **æ¶æ„**: ARMv7 (32ä½)
        - **æ„å»ºæ—¥æœŸ**: $(date +%Y-%m-%d)
        - **é•œåƒå¤§å°**: çº¦ 800MB (æœªå‹ç¼©)
        - **å‹ç¼©å¤§å°**: çº¦ $(ls -lh rootfs-32.img.gz | awk '{print $5}')
        
        ## é»˜è®¤é…ç½®
        - **ä¸»æœºå**: hi3798mv100
        - **rootå¯†ç **: root123
        - **SSH**: å·²å¯ç”¨ï¼Œå…è®¸rootç™»å½•
        - **è½¯ä»¶æº**: åä¸ºäº‘é•œåƒ
        - **æ—¶åŒº**: Asia/Shanghai
        
        ## åŒ…å«çš„è½¯ä»¶åŒ…
        - systemd, dbus
        - OpenSSH Server/Client
        - ç½‘ç»œå·¥å…· (ifupdown, net-tools, iproute2)
        - å¸¸ç”¨å·¥å…· (vim, htop, wget, curl)
        - ç³»ç»ŸæœåŠ¡ (cron, rsyslog)
        
        ## ä½¿ç”¨è¯´æ˜
        1. é€šè¿‡ TTL åˆ·æœºæˆ– recoverbackup æ¢å¤
        2. é¦–æ¬¡å¯åŠ¨åæ‰§è¡Œ: `resize2fs /dev/mmcblk0p9`
        3. SSHç™»å½•: `ssh root@<è®¾å¤‡IP>` (å¯†ç : root123)
        
        ## æ³¨æ„äº‹é¡¹
        - è¿™æ˜¯çº¯å‡€ Ubuntu ç³»ç»Ÿï¼Œæ— ç¬¬ä¸‰æ–¹ä¿®æ”¹
        - åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦æ•°æ®
        EOF

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          rootfs-32.img
          rootfs-32.img.gz
          RELEASE_NOTES.md
        tag_name: pure-v1.0
        name: "çº¯å‡€ Ubuntu RootFS v1.0"
        body: |
          # çº¯å‡€ Ubuntu 20.04 ç³»ç»Ÿé•œåƒ
          
          ## ğŸ†• æ–°ç‰ˆæœ¬ç‰¹æ€§
          - åŸºäºå®˜æ–¹ Ubuntu 20.04.5 Base
          - å®Œå…¨çº¯å‡€ï¼Œæ— ç¬¬ä¸‰æ–¹ä¿®æ”¹
          - ä¼˜åŒ–æ„å»ºæµç¨‹ï¼Œè§£å†³ç©ºé—´ä¸è¶³é—®é¢˜
          - é¢„é…ç½®åä¸ºäº‘è½¯ä»¶æº
          
          ## ğŸ“¦ æ–‡ä»¶è¯´æ˜
          - `rootfs-32.img` - åŸå§‹é•œåƒæ–‡ä»¶ (çº¦800MB)
          - `rootfs-32.img.gz` - å‹ç¼©ç‰ˆæœ¬ (çº¦300MB)
          
          ## ğŸ”§ åˆ·æœºæ–¹æ³•
          1. æ›¿æ¢åŸåˆ·æœºåŒ…ä¸­çš„ rootfs-32.img
          2. ä½¿ç”¨ TTL å·¥å…·åˆ·æœº
          3. æˆ–é€šè¿‡ recoverbackup æ¢å¤
          
          ## âš ï¸ é¦–æ¬¡å¯åŠ¨
          ```bash
          resize2fs /dev/mmcblk0p9
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        sudo rm -rf ubuntu_rootfs temp_mount 2>/dev/null || true
        rm -f ubuntu-base-20.04.5-base-armhf.tar.gz 2>/dev/null || true
        
        # å¯é€‰ï¼šä¿ç•™æœ€ç»ˆé•œåƒæ–‡ä»¶
        echo "ä¿ç•™çš„æ„å»ºäº§ç‰©:"
        ls -lh *.img* 2>/dev/null || echo "æ— é•œåƒæ–‡ä»¶"

    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ github.workspace }}/*.log
        retention-days: 7
